<!-- Extends the layout from /views/layout.html -->
{% extends 'layout.html' %}

<!-- Set the page title -->
{% block pageTitle %}
  {{ serviceName }}
{% endblock %}

<!-- For adding a breadcrumb -->
{% block beforeContent %}
{% endblock %}

{% block content %}
<div class="nhsuk-grid-row">
  <div class="nhsuk-grid-column-two-thirds">
    <form action="search" method="post">

      <div class="nhsuk-grid-row">
        <div class="nhsuk-grid-column-two-thirds">
          <h1 class="nhsuk-heading-l">Search</h1>
        </div>
      </div>

      <div class="nhsuk-hint" id="example-with-hint-text-hint">
    You can use one or more search fields to find results
  </div>

      <div class="nhsuk-grid-row">
        <div class="nhsuk-grid-column-one-third">
          <div class="nhsuk-form-group">
            <label class="nhsuk-label" for="ea-reference">EA reference</label>
            <input class="nhsuk-input nhsuk-input--width-20" id="ea-reference" name="ea-reference" type="text">
          </div>
        </div>

        <div class="nhsuk-grid-column-one-third">
          <div class="nhsuk-form-group">
            <label class="nhsuk-label" for="name">Name</label>
            <input class="nhsuk-input nhsuk-input--width-20" id="name" name="name" type="text">
          </div>
        </div>

        <div class="nhsuk-grid-column-one-third">
          <div class="nhsuk-form-group">
            <label class="nhsuk-label" for="postcode">Postcode</label>
            <input class="nhsuk-input nhsuk-input--width-5" id="postcode" name="postcode" type="text">
          </div>
        </div>
      </div>

      <!-- Reset Button -->
      <div class="nhsuk-grid-row">
        <div class="nhsuk-grid-column-two-thirds">
          <button class="nhsuk-button" type="submit">Search</button>
          <button class="nhsuk-button nhsuk-button--secondary" type="button" id="clear-search" style="margin-left: 10px;">
            Reset
          </button>
        </div>
      </div>

      <!-- Search results header -->
      <h2 id="search-results-heading" class="nhsuk-heading-l nhsuk-u-margin-top-5" style="display: none;">Search results</h2>

      <!-- No results message -->
      <p id="no-results-message" class="nhsuk-body" style="display: none;">No results found</p>

<style>
  .sortable {
    cursor: pointer;
    user-select: none;
  }

  .sort-arrow {
    margin-left: 5px;
    font-size: 0.7em;
  }
</style>

<table id="search-results-table" role="table" class="nhsuk-table-responsive" style="display: none;">
  <thead role="rowgroup" class="nhsuk-table__head">
    <tr role="row">
      <th role="columnheader" scope="col" class="sortable" onclick="sortTable(0, this)">
        EA Reference <span class="sort-arrow"></span>
      </th>
      <th role="columnheader" scope="col" class="sortable" onclick="sortTable(1, this)">
        Name <span class="sort-arrow"></span>
      </th>
      <th role="columnheader" scope="col" class="sortable" onclick="sortTable(2, this)">
        Postcode <span class="sort-arrow"></span>
      </th>
      <th role="columnheader" scope="col">Action</th>
    </tr>
  </thead>
 <tbody class="nhsuk-table__body">
          <tr>
            <td>0681</td>
            <td>NHS Dorset Integrated Care Board (PCSE)</td>
            <td>DL1 9QN</td>
            <td><a href="ea-details?ref=0681&name=NHS%20Dorset%20Integrated%20Care%20Board%20(PCSE)&postcode=DL1%209QN">Details</a></td>
          </tr>
          <tr>
            <td>0682</td>
            <td>NHS Buckinghamshire, Oxfordshire and Berkshire West Integrated Care Board (PCSE)</td>
            <td>DL1 9QN</td>
            <td><a href="ea-details?ref=0682&name=NHS%20Buckinghamshire,%20Oxfordshire%20and%20Berkshire%20West%20Integrated%20Care%20Board%20(PCSE)&postcode=DL1%209QN">Details</a></td>
          </tr>
          <tr>
            <td>0683</td>
            <td>NHS Gloucestershire Integrated Care Board (PCSE)</td>
            <td>DL1 9QN</td>
            <td><a href="ea-details?ref=0683&name=NHS%20Gloucestershire%20Integrated%20Care%20Board%20(PCSE)&postcode=DL1%209QN">Details</a></td>
          </tr>
          <tr>
            <td>0684</td>
            <td>NHS Cornwall and the Isles of Scilly Integrated Care Board (PCSE)</td>
            <td>DL1 9QN</td>
            <td><a href="ea-details?ref=0684&name=NHS%20Cornwall%20and%20the%20Isles%20of%20Scilly%20Integrated%20Care%20Board%20(PCSE)&postcode=DL1%209QN">Details</a></td>
          </tr>
          <tr>
            <td>0685</td>
            <td>NHS Somerset Integrated Care Board (PCSE)</td>
            <td>DL1 9QN</td>
            <td><a href="ea-details?ref=0685&name=NHS%20Somerset%20Integrated%20Care%20Board%20(PCSE)&postcode=DL1%209QN">Details</a></td>
          </tr>
          <tr>
            <td>0686</td>
            <td>NHS Hampshire and Isle of Wight Integrated Care Board (PCSE)</td>
            <td>DL1 9QN</td>
            <td><a href="ea-details?ref=0686&name=NHS%20Hampshire%20and%20Isle%20of%20Wight%20Integrated%20Care%20Board%20(PCSE)&postcode=DL1%209QN">Details</a></td>
          </tr>
          <tr>
            <td>0687</td>
            <td>NHS Sussex Integrated Care Board (PCSE)</td>
            <td>DL1 9QN</td>
            <td><a href="ea-details?ref=0687&name=NHS%20Sussex%20Integrated%20Care%20Board%20(PCSE)&postcode=DL1%209QN">Details</a></td>
          </tr>
          <tr>
            <td>0689</td>
            <td>NHS Bath and North East Somerset, Swindon and Wiltshire Integrated Care Board (PCSE)</td>
            <td>DL1 9QN</td>
            <td><a href="ea-details?ref=0689&name=NHS%20Bath%20and%20North%20East%20Somerset,%20Swindon%20and%20Wiltshire%20Integrated%20Care%20Board%20(PCSE)&postcode=DL1%209QN">Details</a></td>
          </tr>
          <tr>
            <td>0690</td>
            <td>NHS Bristol, North Somerset and South Gloucestershire Integrated Care Board (PCSE)</td>
            <td>DL1 9QN</td>
            <td><a href="ea-details?ref=0690&name=NHS%20Bristol,%20North%20Somerset%20and%20South%20Gloucestershire%20Integrated%20Care%20Board%20(PCSE)&postcode=DL1%209QN">Details</a></td>
          </tr>
          <tr>
            <td>0693</td>
            <td>NHS Surrey Heartlands Integrated Care Board (PCSE)</td>
            <td>DL1 9QN</td>
            <td><a href="ea-details?ref=0693&name=NHS%20Surrey%20Heartlands%20Integrated%20Care%20Board%20(PCSE)&postcode=DL1%209QN">Details</a></td>
          </tr>
          <tr>
            <td>0695</td>
            <td>NHS Devon Integrated Care Board (PCSE)</td>
            <td>DL1 9QN</td>
            <td><a href="ea-details?ref=0695&name=NHS%20Devon%20Integrated%20Care%20Board%20(PCSE)&postcode=DL1%209QN">Details</a></td>
          </tr>
          <tr>
            <td>0701</td>
            <td>Great Ormond Street Hospital for Children NHS Foundation Trust</td>
            <td>LS11 0EA</td>
            <td><a href="ea-details?ref=0701&name=Great%20Ormond%20Street%20Hospital%20for%20Children%20NHS%20Foundation%20Trust&postcode=LS11%200EA">Details</a></td>
          </tr>
          <tr>
            <td>0704</td>
            <td>Moorfields Eye Hospital NHS Foundation Trust</td>
            <td>LS11 0EA</td>
            <td><a href="ea-details?ref=0704&name=Moorfields%20Eye%20Hospital%20NHS%20Foundation%20Trust&postcode=LS11%200EA">Details</a></td>
          </tr>
          <tr>
            <td>0705</td>
            <td>South London and Maudsley NHS Foundation Trust</td>
            <td>LS11 0EA</td>
            <td><a href="ea-details?ref=0705&name=South%20London%20and%20Maudsley%20NHS%20Foundation%20Trust&postcode=LS11%200EA">Details</a></td>
          </tr>
          <tr>
            <td>0706</td>
            <td>London North West University Healthcare NHS Trust</td>
            <td>LS11 0EA</td>
            <td><a href="ea-details?ref=0706&name=London%20North%20West%20University%20Healthcare%20NHS%20Trust&postcode=LS11%200EA">Details</a></td>
          </tr>
          <tr>
            <td>0707</td>
            <td>Central and North West London NHS Foundation Trust</td>
            <td>LS11 0EA</td>
            <td><a href="ea-details?ref=0707&name=Central%20and%20North%20West%20London%20NHS%20Foundation%20Trust&postcode=LS11%200EA">Details</a></td>
          </tr>
          <tr>
            <td>0708</td>
            <td>Hertfordshire Community NHS Trust</td>
            <td>LS11 0EA</td>
            <td><a href="ea-details?ref=0708&name=Hertfordshire%20Community%20NHS%20Trust&postcode=LS11%200EA">Details</a></td>
          </tr>
          <tr>
            <td>0709</td>
            <td>East London NHS Foundation Trust</td>
            <td>LS11 0EA</td>
            <td><a href="ea-details?ref=0709&name=East%20London%20NHS%20Foundation%20Trust&postcode=LS11%200EA">Details</a></td>
          </tr>
          <tr>
            <td>0710</td>
            <td>North East London NHS Foundation Trust</td>
            <td>LS11 0EA</td>
            <td><a href="ea-details?ref=0710&name=North%20East%20London%20NHS%20Foundation%20Trust&postcode=LS11%200EA">Details</a></td>
          </tr>
          <tr>
            <td>0711</td>
            <td>Oxleas NHS Foundation Trust</td>
            <td>LS11 0EA</td>
            <td><a href="ea-details?ref=0711&name=Oxleas%20NHS%20Foundation%20Trust&postcode=LS11%200EA">Details</a></td>
          </tr>
        </tbody>
      </table>

      <!-- Optional pagination (commented out) -->
      <!--
      <nav class="nhsuk-pagination" id="search-pagination" style="display: none;" role="navigation" aria-label="Pagination">
        <ul class="nhsuk-list nhsuk-pagination__list">
          <li class="nhsuk-pagination-item--previous">
            <a class="nhsuk-pagination__link" href="#" aria-label="Previous page">
              <span class="nhsuk-pagination__title">Previous</span>
              <span class="nhsuk-u-visually-hidden">:</span>
              <span class="nhsuk-pagination__page">1 of 3</span>
            </a>
          </li>
          <li class="nhsuk-pagination-item--next">
            <a class="nhsuk-pagination__link" href="#" aria-label="Next page">
              <span class="nhsuk-pagination__title">Next</span>
              <span class="nhsuk-u-visually-hidden">:</span>
              <span class="nhsuk-pagination__page">Page 3</span>
            </a>
          </li>
        </ul>
      </nav>
      -->

    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.querySelector('form');
    const table = document.getElementById('search-results-table');
    const heading = document.getElementById('search-results-heading');
    const noResultsMessage = document.getElementById('no-results-message');
    const pagination = document.getElementById('search-pagination');

    form.addEventListener('submit', function (e) {
      e.preventDefault();

      const eaRefInput = document.getElementById('ea-reference').value.trim().toLowerCase();
      const nameInput = document.getElementById('name').value.trim().toLowerCase();
      const postcodeInput = document.getElementById('postcode').value.trim().toLowerCase();

      const rows = table.querySelectorAll('tbody tr');
      let visibleRowsCount = 0;

      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const eaRef = cells[0].textContent.trim().toLowerCase();
        const name = cells[1].textContent.trim().toLowerCase();
        const postcode = cells[2].textContent.trim().toLowerCase();

        const matchesEARef = !eaRefInput || eaRef.includes(eaRefInput);
        const matchesName = !nameInput || name.includes(nameInput);
        const matchesPostcode = !postcodeInput || postcode.includes(postcodeInput);

        if (matchesEARef && matchesName && matchesPostcode) {
          row.style.display = '';
          visibleRowsCount++;
        } else {
          row.style.display = 'none';
        }
      });

      if (visibleRowsCount > 0) {
        table.style.display = 'table';
        heading.style.display = 'block';
        noResultsMessage.style.display = 'none';
        if (pagination) pagination.style.display = 'block';
      } else {
        table.style.display = 'none';
        heading.style.display = 'block';
        noResultsMessage.style.display = 'block';
        if (pagination) pagination.style.display = 'none';
      }
    });

    // Clear search button behavior
    document.getElementById('clear-search').addEventListener('click', function(e) {
      e.preventDefault();

      document.getElementById('ea-reference').value = '';
      document.getElementById('name').value = '';
      document.getElementById('postcode').value = '';

      table.style.display = 'none';
      heading.style.display = 'none';
      noResultsMessage.style.display = 'none';
      if (pagination) pagination.style.display = 'none';
    });
    
  });
</script>

<script>
  let currentSort = {
    column: null,
    ascending: true
  };

  function sortTable(columnIndex, headerElement) {
    const table = document.getElementById("search-results-table");
    const tbody = table.tBodies[0];
    const rows = Array.from(tbody.rows);

    // Toggle sort direction if same column, else reset
    const isSameColumn = currentSort.column === columnIndex;
    currentSort.ascending = isSameColumn ? !currentSort.ascending : true;
    currentSort.column = columnIndex;

    // Remove sort arrows from all headers
    document.querySelectorAll('.sort-arrow').forEach(arrow => arrow.textContent = '');

    // Set arrow on the current header
    const arrowSpan = headerElement.querySelector('.sort-arrow');
    arrowSpan.textContent = currentSort.ascending ? '▲' : '▼';

    // Sort rows
    rows.sort((a, b) => {
      let cellA = a.cells[columnIndex].textContent.trim().toLowerCase();
      let cellB = b.cells[columnIndex].textContent.trim().toLowerCase();

      if (columnIndex === 0) { // EA Reference is numeric
        cellA = parseInt(cellA, 10);
        cellB = parseInt(cellB, 10);
      }

      if (cellA < cellB) return currentSort.ascending ? -1 : 1;
      if (cellA > cellB) return currentSort.ascending ? 1 : -1;
      return 0;
    });

    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
  }
</script>

{% endblock %}